# **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `kernel/` (–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —è–¥—Ä–∞)**

–¢—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.

- `sched.c` ‚Äì –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
- `signal.c` ‚Äì –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ (`kill`, `SIGTERM`).
- `exit.c` ‚Äì –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
- `fork.c` ‚Äì —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `fork()`.

üìå –ü—Ä–æ—Å—Ç–∞—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ **round-robin** –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## **üóì 30.01.2025**
- üïô **22:45** ‚Äì –•–æ—á—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –Ω–∞—á–Ω—É —Å `sched.c` –∏ `system.h` ‚Äì —Ç–∞–º –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ —è–¥—Ä–∞.

## **üóì 31.01.2025**
- üïõ **00:05** ‚Äì –û—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –Ω–∞ `extern int system_call(void);` –≤ [sched.c](sched.c).

---

## **üîπ –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ `0x80`**

### üîç **–ö–∞–∫ `int 0x80` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `eax`?**
–ö–æ–≥–¥–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ (**syscall**), —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ **—Ä–µ–≥–∏—Å—Ç—Ä `eax`**, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å.

---

## **üìå –†–∞–∑–±–µ—Ä—ë–º –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ `sys_write()`**
–î–æ–ø—É—Å—Ç–∏–º, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `write(1, "Hello", 5)`, –∫–æ—Ç–æ—Ä—ã–π –≤ —è–¥—Ä–µ Linux —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç **—Å–∏—Å—Ç–µ–º–Ω–æ–º—É –≤—ã–∑–æ–≤—É –Ω–æ–º–µ—Ä `4`**.

### **1Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (`C -> ASM`)**
–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `write()`, **glibc** –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ `int 0x80`:

```assembly
movl \$4, %eax       # –ö–æ–¥ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (sys_write)
movl \$1, %ebx       # –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Ñ–∞–π–ª–∞ (stdout)
movl \$message, %ecx # –ê–¥—Ä–µ—Å —Å—Ç—Ä–æ–∫–∏ "Hello"
movl \$5, %edx       # –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏
int \$0x80           # –í—ã–∑–æ–≤ —è–¥—Ä–∞
movl %eax, result   # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–π—Ç)
```

üìå **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**
- **`eax = 4`** ‚Üí –≠—Ç–æ `sys_write()`.
- **`ebx = 1`** ‚Üí `stdout` (—ç–∫—Ä–∞–Ω).
- **`ecx = message`** ‚Üí –ê–¥—Ä–µ—Å `"Hello"`.
- **`edx = 5`** ‚Üí –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏.

–ü–æ—Å–ª–µ `int 0x80` —è–¥—Ä–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `sys_write()` –∏ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–π—Ç –≤ `eax`**.

---

### **2Ô∏è‚É£ –í–Ω—É—Ç—Ä–∏ —è–¥—Ä–∞ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `system_call`)**
–§—É–Ω–∫—Ü–∏—è `system_call()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ **`sys_call_table[]`**:

```assembly
system_call:
    push %ds
    push %es
    push %fs
    pushl %eax
    cmpl \$NR_syscalls-1, %eax
    jae bad_sys_call
    call *sys_call_table(, %eax, 4)  # –í—ã–∑–æ–≤ sys_write() (–µ—Å–ª–∏ eax == 4)
    addl \$4, %esp
    popl %eax   # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ eax
    pop %fs
    pop %es
    pop %ds
    iret        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥
```

üìå **–ö–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `eax`?**
1. `call *sys_call_table(, %eax, 4)` –≤—ã–∑—ã–≤–∞–µ—Ç `sys_write()`.
2. `sys_write()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–π—Ç**.
3. –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ **–ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ `eax`**.
4. `iret` –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É `int 0x80`, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

### **3Ô∏è‚É£ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `sys_write()` –≤ —è–¥—Ä–µ (`fs/read_write.c`)**
```c
int sys_write(unsigned int fd, const char *buf, size_t count) {
    int written = 0;
    while (count--) {
        put_char(*buf++);  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–∏–º–≤–æ–ª
        written++;         // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
    }
    return written;  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–π—Ç
}
```

üìå **–†–∞–∑–±–æ—Ä –∫–æ–¥–∞:**
- –ï—Å–ª–∏ `count = 5`, —Ñ—É–Ω–∫—Ü–∏—è **–∑–∞–ø–∏—à–µ—Ç 5 —Å–∏–º–≤–æ–ª–æ–≤** –∏ **–≤–µ—Ä–Ω—ë—Ç `5`**.
- –ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ `sys_write()`, –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ **–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `eax`**.
- –ö–æ–≥–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤–∏–¥–∏—Ç, —á—Ç–æ –≤ `eax` —Ö—Ä–∞–Ω–∏—Ç—Å—è `5`.

---

### **4Ô∏è‚É£ –ö–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–ª—É—á–∞–µ—Ç `eax`?**
–ü–æ—Å–ª–µ `int 0x80`, –ø—Ä–æ–≥—Ä–∞–º–º–∞ **—á–∏—Ç–∞–µ—Ç `eax`**, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç `sys_write()`.

```assembly
movl %eax, result  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω–æ–µ —è–¥—Ä–æ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
```

üìå **–í `C` —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:**
```c
int result = write(1, "Hello", 5);
printf("–ó–∞–ø–∏—Å–∞–Ω–æ –±–∞–π—Ç: %d\n", result);
```

–í—ã–≤–µ–¥–µ—Ç:
```
–ó–∞–ø–∏—Å–∞–Ω–æ –±–∞–π—Ç: 5
```

---

## **‚úÖ –ò—Ç–æ–≥**
- **–ü—Ä–æ–≥—Ä–∞–º–º—ã –ø–µ—Ä–µ–¥–∞—é—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ `eax, ebx, ecx, edx` –ø–µ—Ä–µ–¥ `int 0x80`**.
- **–Ø–¥—Ä–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `eax`**.
- **–ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ —Å—á–∏—Ç—ã–≤–∞–µ—Ç `eax`**, –≥–¥–µ –ª–µ–∂–∏—Ç –æ—Ç–≤–µ—Ç.

üöÄ **–¢–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∫–æ–¥–æ–º –∏ —è–¥—Ä–æ–º –≤ Linux 0.11!**
